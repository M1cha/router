#!/bin/bash
set -xuo pipefail

unit="$1"
status=1
logs=$(journalctl -u "$unit" -n15)
podman_unit=$(journalctl -u "$unit" -t podman -n10 | sed -n 's/.*PODMAN_SYSTEMD_UNIT=\([a-zA-Z0-9:-_.]\+\),.*/\1/p' | tail -n1)
app_token=$(podman secret inspect --showsecret systemd_gotify_token | jq -r '.[0].SecretData')

extra=""
if [ "$podman_unit" != "" ]; then
  extra="${extra}($podman_unit)"
fi

# Even if the service is up, it may not be listening to the port yet.
# So lets retry a few times
for i in {1..3}; do
  curl -v \
      "https://gotify.homeserver.home.arpa/message?token=${app_token}" \
      -F "title=router systemd" \
      -F "message=${unit}${extra} failed: $logs" \
      -F "priority=5" \
  && status=0 && break
  sleep 2
done

exit "$status"
